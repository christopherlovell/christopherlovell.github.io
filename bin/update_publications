#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

if ! python3 -c "import ads" >/dev/null 2>&1; then
  echo "Error: Python package 'ads' is not available for python3."
  echo "Install it in your active environment, then rerun this script."
  exit 1
fi

if [[ -z "${ADS_DEV_KEY:-}" ]]; then
  echo "Error: ADS_DEV_KEY is not set."
  echo "Export your ADS token, then rerun this script."
  exit 1
fi

TMP_TEX="$(mktemp "${TMPDIR:-/tmp}/publications.XXXXXX.tex")"
cleanup() {
  rm -f "$TMP_TEX"
}
trap cleanup EXIT

echo "Updating publications from ADS..."
python3 build_publication_list.py > "$TMP_TEX"
mv "$TMP_TEX" publications.tex

echo "Generating HTML include..."
python3 generate_publications_html.py

stats_line="$(grep -m1 '^% ADS_STATS ' publications.tex || true)"
if [[ -n "$stats_line" ]]; then
  echo "Done: ${stats_line#% ADS_STATS }"
else
  echo "Done: publications updated (no ADS stats metadata found)."
fi
